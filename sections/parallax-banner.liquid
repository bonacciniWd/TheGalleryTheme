{% comment %}
  Seção de Comparação de Imagens Estilo Apple Watch para Shopify
  Recria o efeito de slider de comparação de imagens do site da Apple,
  com as imagens fixas e o slider agindo como uma "janela" de revelação.
{% endcomment %}

<style>
  /* Estilos para a seção principal */
  .section-apple-watch-comparison-{{ section.id }} {
    position: relative;
    width: 100%;
    max-width: {{ section.settings.max_width }}px; /* Largura máxima da seção */
    margin: 0 auto;
    background-color: {{ section.settings.background_color }};
    padding: 3rem 0; /* Espaçamento vertical */
    box-sizing: border-box;
    font-family: 'Inter', sans-serif; /* Ou sua fonte de tema padrão */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* Estilos para os títulos (Series 7, 8, 9 vs. Series 10) */
  .apple-watch-comparison-title-wrapper-{{ section.id }} {
    width: 100%;
    max-width: {{ section.settings.max_width }}px;
    padding: 0 1rem;
    box-sizing: border-box;
    margin-bottom: 1.5rem;
  }

  .apple-watch-comparison-title-row-{{ section.id }} {
    display: flex;
    justify-content: space-between;
    width: 100%;
  }

  .apple-watch-comparison-column-{{ section.id }} {
    flex: 1; /* Distribui o espaço igualmente */
    text-align: center;
  }

  .apple-watch-comparison-column-{{ section.id }}.left {
    text-align: left;
  }

  .apple-watch-comparison-column-{{ section.id }}.right {
    text-align: right;
  }

  .apple-watch-comparison-image-title-{{ section.id }} {
    font-size: 1.2rem;
    font-weight: 600;
    color: {{ section.settings.text_color }};
    margin: 0;
  }

  /* Container principal da comparação de imagens */
  .apple-watch-comparison-container-{{ section.id }} {
    position: relative;
    width: 100%;
    /* padding-top para manter o aspect ratio da imagem */
    padding-top: {{ 100 | divided_by: section.settings.aspect_ratio }}%;
    overflow: hidden; /* ESSENCIAL para o recorte */
    border-radius: 1rem;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    cursor: ew-resize; /* Cursor para indicar arrastar horizontalmente */
  }

  /* Imagem 'Antes' (Series 7, 8, 9) - base, fica por baixo */
  .apple-watch-comparison-image-before-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* Camada inferior */
    display: flex; /* Para centralizar a imagem se necessário */
    align-items: center;
    justify-content: center;
  }

  .apple-watch-comparison-image-before-{{ section.id }} img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover; /* Garante que a imagem cubra o espaço sem distorção */
    pointer-events: none; /* Impede arrastar a imagem */
  }

  /* Máscara de recorte para a imagem 'Depois' (Series 10) */
  .apple-watch-comparison-clipper-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0; /* A largura e a posição 'left' serão controladas pelo JS */
    height: 100%;
    overflow: hidden; /* ESSENCIAL para o recorte */
    z-index: 2; /* Camada superior */
  }

  /* Imagem 'Depois' (Series 10) - fica DENTRO do clipper */
  /* Esta imagem SEMPRE terá a largura total do container principal,
     e seu 'left' será ajustado para simular o recorte */
  .apple-watch-comparison-clipper-{{ section.id }} img {
    position: absolute;
    top: 0;
    left: 0; /* A posição 'left' será ajustada pelo JS */
    /* A largura será definida pelo JS para ser igual à largura do container principal */
    height: 100%;
    object-fit: cover;
    pointer-events: none;
  }

  /* Barra (linha vertical) do slider */
  .apple-watch-comparison-bar-{{ section.id }} {
    position: absolute;
    left: 50%; /* Posição inicial, será ajustada pelo JS */
    top: 0;
    bottom: 0;
    width: 2px; /* Espessura da linha */
    background-color: {{ section.settings.slider_line_color }};
    z-index: 3; /* Acima das imagens */
    transform: translateX(-50%); /* Centraliza a linha */
  }

  /* Handle (círculo) do slider */
  .apple-watch-comparison-handle-{{ section.id }} {
    position: absolute;
    top: 50%;
    left: 50%; /* Posição inicial, será ajustada pelo JS */
    width: 40px; /* Largura do handle */
    height: 40px; /* Altura do handle */
    background-color: {{ section.settings.slider_handle_color }};
    border: 2px solid {{ section.settings.slider_line_color }};
    border-radius: 50%;
    cursor: grab;
    z-index: 4; /* Acima da linha */
    transform: translate(-50%, -50%); /* Centraliza o handle */
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    user-select: none; /* Impede seleção de texto ao arrastar */
  }

  .apple-watch-comparison-handle-{{ section.id }}:active {
    cursor: grabbing;
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .apple-watch-comparison-image-title-{{ section.id }} {
      font-size: 1rem;
    }
    .apple-watch-comparison-handle-{{ section.id }} {
      width: 30px;
      height: 30px;
      font-size: 1rem;
    }
  }
</style>

<section class="section-apple-watch-comparison-{{ section.id }}">
  {% if section.settings.heading != blank %}
    <h2 style="color: {{ section.settings.text_color }}; font-size: 2.5rem; font-weight: 700; margin-bottom: 1.5rem;">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="apple-watch-comparison-title-wrapper-{{ section.id }}">
    <div class="apple-watch-comparison-title-row-{{ section.id }}">
      <div class="apple-watch-comparison-column-{{ section.id }} left">
        <p class="apple-watch-comparison-image-title-{{ section.id }}">{{ section.settings.label_before }}</p>
      </div>
      <div class="apple-watch-comparison-column-{{ section.id }} right">
        <p class="apple-watch-comparison-image-title-{{ section.id }}">{{ section.settings.label_after }}</p>
      </div>
    </div>
  </div>

  <div class="apple-watch-comparison-container-{{ section.id }}" role="image" aria-label="Animation of an interactive slider moving between two images to show the difference.">
    <div class="apple-watch-comparison-image-before-{{ section.id }}">
      {% if section.settings.image_before != blank %}
        {% assign img_before = section.settings.image_before %}
        <img src="{{ img_before | img_url: 'master' }}"
             srcset="{{ img_before | img_url: '400x' }} 400w,
                     {{ img_before | img_url: '800x' }} 800w,
                     {{ img_before | img_url: '1200x' }} 1200w,
                     {{ img_before | img_url: '1600x' }} 1600w"
             sizes="(max-width: 768px) 100vw, {{ section.settings.max_width }}px"
             alt="{{ section.settings.label_before | default: 'Imagem Antes' }}">
      {% else %}
        <img src="https://placehold.co/1200x900/E0E0E0/333333?text=Imagem+Antes" alt="Placeholder Imagem Antes">
      {% endif %}
    </div>

    <div class="apple-watch-comparison-clipper-{{ section.id }}">
      {% if section.settings.image_after != blank %}
        {% assign img_after = section.settings.image_after %}
        <img class="apple-watch-comparison-image-after-{{ section.id }}"
             src="{{ img_after | img_url: 'master' }}"
             srcset="{{ img_after | img_url: '400x' }} 400w,
                     {{ img_after | img_url: '800x' }} 800w,
                     {{ img_after | img_url: '1200x' }} 1200w,
                     {{ img_after | img_url: '1600x' }} 1600w"
             sizes="(max-width: 768px) 100vw, {{ section.settings.max_width }}px"
             alt="{{ section.settings.label_after | default: 'Imagem Depois' }}">
      {% else %}
        <img class="apple-watch-comparison-image-after-{{ section.id }}"
             src="https://placehold.co/1200x900/A0A0A0/FFFFFF?text=Imagem+Depois" alt="Placeholder Imagem Depois">
      {% endif %}
    </div>

    <div class="apple-watch-comparison-bar-{{ section.id }}"></div>
    <div class="apple-watch-comparison-handle-{{ section.id }}">
      &#x2194; </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionId = '{{ section.id }}';
    const container = document.querySelector(`.apple-watch-comparison-container-${sectionId}`);
    const clipper = document.querySelector(`.apple-watch-comparison-clipper-${sectionId}`);
    const afterImgElement = clipper ? clipper.querySelector('img') : null; // A tag <img> real dentro do clipper
    const sliderBar = document.querySelector(`.apple-watch-comparison-bar-${sectionId}`);
    const sliderHandle = document.querySelector(`.apple-watch-comparison-handle-${sectionId}`);

    // Adiciona logs para depuração
    console.log(`[Apple Watch Slider ${sectionId}] Inicializando...`);
    console.log(`[Apple Watch Slider ${sectionId}] Container:`, container);
    console.log(`[Apple Watch Slider ${sectionId}] Clipper (Máscara):`, clipper);
    console.log(`[Apple Watch Slider ${sectionId}] Imagem 'Depois':`, afterImgElement);
    console.log(`[Apple Watch Slider ${sectionId}] Barra do Slider:`, sliderBar);
    console.log(`[Apple Watch Slider ${sectionId}] Handle do Slider:`, sliderHandle);

    if (!container || !clipper || !afterImgElement || !sliderBar || !sliderHandle) {
      console.error(`[Apple Watch Slider ${sectionId}] ERRO: Um ou mais elementos essenciais não foram encontrados. O slider não funcionará.`);
      return;
    }

    let isDragging = false;

    // Função para atualizar a posição do slider e o recorte da imagem 'after'
    function updateSlider(e) {
      const containerRect = container.getBoundingClientRect();
      let clientX;

      if (e.touches && e.touches.length > 0) { // Para eventos de toque
        clientX = e.touches[0].clientX;
      } else { // Para eventos de mouse
        clientX = e.clientX;
      }

      let x = clientX - containerRect.left; // Posição X relativa ao container

      // Limita o movimento do slider dentro do container
      if (x < 0) x = 0;
      if (x > containerRect.width) x = containerRect.width;

      // 1. Atualiza a largura do clipper (máscara)
      clipper.style.width = `${x}px`;
      // 2. Garante que a imagem 'Depois' (dentro do clipper) tenha a largura total do container
      afterImgElement.style.width = `${containerRect.width}px`;
      // 3. Ajusta a posição 'left' da imagem 'Depois' para mantê-la alinhada
      afterImgElement.style.left = `-${x}px`;

      // 4. Atualiza a posição da barra e do handle do slider
      sliderBar.style.left = `${x}px`;
      sliderHandle.style.left = `${x}px`;

      // console.log(`[Slider ${sectionId}] X: ${x}, Clipper Width: ${x}, After Img Width: ${containerRect.width}, After Img Left: ${-x}`); // Para depuração
    }

    // Eventos de mouse
    sliderHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      sliderHandle.style.cursor = 'grabbing';
      e.preventDefault(); // Previne arrastar a imagem ou seleção de texto
      console.log(`[Apple Watch Slider ${sectionId}] Mousedown: Arrasto iniciado.`);
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        sliderHandle.style.cursor = 'grab';
        console.log(`[Apple Watch Slider ${sectionId}] Mouseup: Arrasto finalizado.`);
      }
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault(); // Previne seleção de texto ou outras ações padrão
      updateSlider(e);
    });

    // Eventos de toque
    sliderHandle.addEventListener('touchstart', (e) => {
      isDragging = true;
      sliderHandle.style.cursor = 'grabbing';
      // e.preventDefault(); // Comentado para permitir rolagem se o toque não for um arrasto do handle
      console.log(`[Apple Watch Slider ${sectionId}] Touchstart: Arrasto iniciado.`);
    }, { passive: false });

    document.addEventListener('touchend', () => {
      if (isDragging) {
        isDragging = false;
        sliderHandle.style.cursor = 'grab';
        console.log(`[Apple Watch Slider ${sectionId}] Touchend: Arrasto finalizado.`);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      e.preventDefault(); // Previne rolagem da página ao arrastar o handle
      updateSlider(e);
    }, { passive: false });

    // Define a posição inicial do slider ao carregar e redimensionar
    function setInitialPosition() {
      const initialPercentage = parseFloat('{{ section.settings.initial_slider_position }}') / 100;
      const containerWidth = container.getBoundingClientRect().width;
      const initialX = containerWidth * initialPercentage;

      // Aplica a posição inicial
      clipper.style.width = `${initialX}px`;
      afterImgElement.style.width = `${containerWidth}px`; // Garante que a imagem 'depois' tenha a largura total
      afterImgElement.style.left = `-${initialX}px`; // Alinha a imagem 'depois'
      sliderBar.style.left = `${initialX}px`;
      sliderHandle.style.left = `${initialX}px`;
      console.log(`[Apple Watch Slider ${sectionId}] Posição inicial definida para ${initialPercentage * 100}% (${initialX}px).`);
    }

    // Adiciona listeners para garantir que a posição inicial seja definida corretamente
    window.addEventListener('load', setInitialPosition);
    window.addEventListener('resize', setInitialPosition);

    // Chama a função uma vez para garantir o estado inicial correto (para o editor de temas)
    setInitialPosition();
  });
</script>


{% schema %}
{
  "name": "Comparação",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título da Seção",
      "default": "A diferença é visível."
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "Imagem 'Antes' (Série 7, 8, 9)",
      "info": "A imagem da série mais antiga."
    },
    {
      "type": "text",
      "id": "label_before",
      "label": "Texto 'Antes'",
      "default": "Series 7, 8, 9"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "Imagem 'Depois' (Série 10)",
      "info": "A imagem da série mais nova."
    },
    {
      "type": "text",
      "id": "label_after",
      "label": "Texto 'Depois'",
      "default": "Series 10"
    },
    {
      "type": "range",
      "id": "initial_slider_position",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Posição Inicial do Slider",
      "default": 50,
      "info": "Define a posição inicial do slider em porcentagem (0% = todo 'depois', 100% = todo 'antes')."
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 300,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "label": "Largura Máxima do Slider",
      "default": 1000,
      "info": "Largura máxima do container de comparação de imagens."
    },
    {
      "type": "range",
      "id": "aspect_ratio",
      "min": 0.5,
      "max": 2.0,
      "step": 0.1,
      "label": "Proporção da Imagem (Largura/Altura)",
      "default": 1.3,
      "info": "Define a proporção da imagem (ex: 1.3 para 4:3, 1.7 para 16:9). Ajuste para a proporção das suas imagens."
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Cor de Fundo da Seção",
      "default": "#f5f5f7"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Cor do Texto",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "slider_line_color",
      "label": "Cor da Linha do Slider",
      "default": "#007aff"
    },
    {
      "type": "color",
      "id": "slider_handle_color",
      "label": "Cor do Handle do Slider",
      "default": "#007aff"
    }
  ],
  "presets": [
    {
      "name": "Comparação de Imagens (Apple Watch)",
      "category": "Imagens e Vídeos"
    }
  ]
}
{% endschema %}
