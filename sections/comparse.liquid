{% comment %}
  Seção de Comparação de Imagens Estilo Apple para Shopify
  Recria o efeito de slider de comparação de imagens visto no site da Apple.
  Permite definir as imagens, textos descritivos, e a posição inicial do slider.
{% endcomment %}

<style>
  /* Estilos essenciais para a seção de comparação de imagens */
  .image-comparison-section-{{ section.id }} {
    position: relative;
    width: 100%;
    max-width: {{ section.settings.max_width }}px; /* Largura máxima da seção */
    margin: 0 auto;
    background-color: {{ section.settings.background_color }};
    padding: 2rem 0; /* Adiciona padding vertical */
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .image-comparison-container-{{ section.id }} {
    position: relative;
    width: 100%;
    /* padding-top para manter o aspect ratio da imagem */
    padding-top: {{ 100 | divided_by: section.settings.aspect_ratio }}%;
    overflow: hidden; /* Importante para o recorte */
    border-radius: 1rem;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    margin-top: 2rem;
    cursor: ew-resize; /* Cursor para indicar arrastar horizontalmente */
  }

  /* Imagem 'Antes' - sempre visível no fundo */
  .image-comparison-before-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* Abaixo da imagem 'depois' e do slider */
  }

  .image-comparison-before-{{ section.id }} img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover; /* Garante que a imagem cubra o espaço sem distorção */
    pointer-events: none; /* Impede que a imagem seja arrastada */
  }

  /* Container da imagem 'Depois' - atua como uma MÁSCARA de recorte (clipper) */
  .image-comparison-after-clipper-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0; /* A largura e a posição 'left' serão controladas pelo JS */
    height: 100%;
    overflow: hidden; /* ESSENCIAL para o recorte */
    z-index: 2; /* Acima da imagem 'before' */
    /* width will be set by JS */
  }

  /* A IMAGEM 'Depois' em si (a tag <img> dentro do clipper) */
  /* Ela deve ter a largura total do container principal e sua posição 'left' ajustada pelo JS */
  .image-comparison-after-clipper-{{ section.id }} img {
    position: absolute;
    top: 0;
    left: 0; /* A posição 'left' será ajustada pelo JS para alinhamento */
    /* A largura será definida pelo JS para ser igual à largura do container principal */
    height: 100%;
    object-fit: cover; /* Garante que a imagem cubra o espaço sem distorção */
    pointer-events: none;
  }

  /* Linha do Slider */
  .image-comparison-slider-line-{{ section.id }} {
    position: absolute;
    left: 50%; /* Posição inicial, será ajustada pelo JS */
    top: 0;
    bottom: 0;
    width: 2px; /* Espessura da linha */
    background-color: {{ section.settings.slider_line_color }};
    z-index: 3; /* Acima das imagens */
    transform: translateX(-50%); /* Centraliza a linha no ponto do slider */
  }

  /* Handle do Slider */
  .image-comparison-slider-handle-{{ section.id }} {
    position: absolute;
    top: 50%;
    left: 50%; /* Posição inicial, será ajustada pelo JS */
    width: 40px; /* Largura do handle */
    height: 40px; /* Altura do handle */
    background-color: {{ section.settings.slider_handle_color }};
    border: 2px solid {{ section.settings.slider_line_color }};
    border-radius: 50%;
    cursor: grab;
    z-index: 4; /* Acima da linha */
    transform: translate(-50%, -50%); /* Centraliza o handle */
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    user-select: none; /* Impede seleção de texto ao arrastar */
  }

  .image-comparison-slider-handle-{{ section.id }}:active {
    cursor: grabbing;
  }

  /* Estilos para os textos descritivos */
  .image-comparison-label-wrapper-{{ section.id }} {
    display: flex;
    justify-content: space-between;
    width: 100%;
    max-width: {{ section.settings.max_width }}px;
    margin-bottom: 1rem;
    padding: 0 1rem;
    box-sizing: border-box;
  }

  .image-comparison-label-{{ section.id }} {
    font-size: 1.2rem;
    font-weight: 600;
    color: {{ section.settings.text_color }};
    text-align: center;
    flex: 1;
  }

  .image-comparison-label-{{ section.id }}.left {
    text-align: left;
  }

  .image-comparison-label-{{ section.id }}.right {
    text-align: right;
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .image-comparison-slider-handle-{{ section.id }} {
      width: 30px;
      height: 30px;
      font-size: 1rem;
    }
    .image-comparison-label-{{ section.id }} {
      font-size: 1rem;
    }
  }
</style>

<section class="image-comparison-section-{{ section.id }}">
  {% if section.settings.heading != blank %}
    <h2 style="color: {{ section.settings.text_color }}; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="image-comparison-label-wrapper-{{ section.id }}">
    {% if section.settings.label_before != blank %}
      <span class="image-comparison-label-{{ section.id }} left">{{ section.settings.label_before }}</span>
    {% endif %}
    {% if section.settings.label_after != blank %}
      <span class="image-comparison-label-{{ section.id }} right">{{ section.settings.label_after }}</span>
    {% endif %}
  </div>

  <div class="image-comparison-container-{{ section.id }}">
    <div class="image-comparison-before-{{ section.id }}">
      {% if section.settings.image_before != blank %}
        <img src="{{ section.settings.image_before | img_url: 'master' }}"
             width="{{ section.settings.image_before.width }}"
             height="{{ section.settings.image_before.height }}"
             srcset="{{ section.settings.image_before | img_url: '400x' }} 400w,
                     {{ section.settings.image_before | img_url: '800x' }} 800w,
                     {{ section.settings.image_before | img_url: '1200x' }} 1200w"
             sizes="(max-width: 768px) 100vw, {{ section.settings.max_width }}px"
             alt="{{ section.settings.label_before | default: 'Imagem Antes' }}">
      {% else %}
        <img src="https://placehold.co/800x600/E0E0E0/333333?text=Imagem+Antes"
             width="800"
             height="600"
             alt="Placeholder Imagem Antes">
      {% endif %}
    </div>

    <div class="image-comparison-after-clipper-{{ section.id }}">
      {% if section.settings.image_after != blank %}
        <img class="image-comparison-after-image-{{ section.id }}"
             src="{{ section.settings.image_after | img_url: 'master' }}"
             width="{{ section.settings.image_after.width }}"
             height="{{ section.settings.image_after.height }}"
             srcset="{{ section.settings.image_after | img_url: '400x' }} 400w,
                     {{ section.settings.image_after | img_url: '800x' }} 800w,
                     {{ section.settings.image_after | img_url: '1200x' }} 1200w"
             sizes="(max-width: 768px) 100vw, {{ section.settings.max_width }}px"
             alt="{{ section.settings.label_after | default: 'Imagem Depois' }}">
      {% else %}
        <img class="image-comparison-after-image-{{ section.id }}"
             src="https://placehold.co/800x600/A0A0A0/FFFFFF?text=Imagem+Depois"
             width="800"
             height="600"
             alt="Placeholder Imagem Depois">
      {% endif %}
    </div>

    <div class="image-comparison-slider-line-{{ section.id }}"></div>
    <div class="image-comparison-slider-handle-{{ section.id }}">
      &#x2194; </div>
  </div>
</section>

<script>
  // Função para inicializar o slider de comparação de imagens
  function initImageComparison(sectionId) {
    const container = document.querySelector(`.image-comparison-container-${sectionId}`);
    const afterClipper = document.querySelector(`.image-comparison-after-clipper-${sectionId}`);
    const afterImage = document.querySelector(`.image-comparison-after-clipper-${sectionId} img`); // Seleciona a imagem DENTRO do clipper
    const sliderLine = document.querySelector(`.image-comparison-slider-line-${sectionId}`);
    const sliderHandle = document.querySelector(`.image-comparison-slider-handle-${sectionId}`);

    if (!container || !afterClipper || !afterImage || !sliderLine || !sliderHandle) {
      console.warn(`[Slider ${sectionId}] Um ou mais elementos não foram encontrados.`);
      return; // Sai se não encontrar todos os elementos
    }

    let isDragging = false;

    // --- Funções de Atualização da Posição ---
    function updateSliderPosition(x) {
      const containerRect = container.getBoundingClientRect();
      const containerWidth = containerRect.width;

      // Garante que 'x' esteja dentro dos limites do container
      let newX = Math.max(0, Math.min(x, containerWidth));

      // Atualiza a largura do clipper da imagem 'Depois'
      afterClipper.style.width = `${newX}px`;

      // Ajusta a posição da imagem 'Depois' DENTRO do clipper para que ela esteja alinhada
      // A imagem 'Depois' precisa ser movida para a esquerda pelo mesmo valor da largura do clipper
      // para que a parte visível da imagem 'Depois' corresponda à parte visível da imagem 'Antes'
      afterImage.style.left = `-${newX}px`;

      // Atualiza a posição da linha do slider e do handle
      sliderLine.style.left = `${newX}px`;
      sliderHandle.style.left = `${newX}px`;

      // Logs de depuração
      console.log(`[Slider ${sectionId} - Movimento]`);
      console.log(`  clientX (raw): ${x}`); // Valor bruto do evento
      console.log(`  containerRect.left: ${containerRect.left}`); // Posição esquerda do container
      console.log(`  containerRect.width: ${containerWidth}`); // Largura total do container
      console.log(`  Calculated X (adjusted): ${newX}`); // Posição X ajustada (limitada)
      console.log(`  Clipper Width: ${afterClipper.style.width}`);
      console.log(`  After Image Left: ${afterImage.style.left}`);
      console.log(`  Slider Line Left: ${sliderLine.style.left}`);
      console.log(`  Slider Handle Left: ${sliderHandle.style.left}`);
      console.log(`---`);
    }

    // --- Event Listeners ---
    sliderHandle.addEventListener('mousedown', (e) => {
      e.preventDefault(); // Evita o arrasto de imagem padrão do navegador
      isDragging = true;
      // Adiciona a classe para mudar o cursor quando estiver a arrastar
      sliderHandle.classList.add('grabbing');
    });

    // Para dispositivos móveis
    sliderHandle.addEventListener('touchstart', (e) => {
      e.preventDefault();
      isDragging = true;
      // Adiciona a classe para mudar o cursor quando estiver a arrastar
      sliderHandle.classList.add('grabbing');
      console.log(`[Slider ${sectionId}] Touchstart: Arrasto iniciado.`);
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const containerRect = container.getBoundingClientRect();
      const x = e.clientX - containerRect.left; // Calcula a posição X relativa ao container
      updateSliderPosition(x);
    });

    // Para dispositivos móveis
    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      // e.touches[0].clientX obtém a posição X do primeiro toque
      const containerRect = container.getBoundingClientRect();
      const x = e.touches[0].clientX - containerRect.left;
      updateSliderPosition(x);
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      // Remove a classe do cursor
      sliderHandle.classList.remove('grabbing');
    });

    // Para dispositivos móveis
    document.addEventListener('touchend', () => {
      isDragging = false;
      // Remove a classe do cursor
      sliderHandle.classList.remove('grabbing');
      console.log(`[Slider ${sectionId}] Touchend: Arrasto finalizado.`);
    });

    // --- Posição Inicial ---
    // Define a posição inicial do slider no centro ao carregar a página
    // e também quando a janela é redimensionada
    function setInitialPosition() {
      console.log(`[Slider ${sectionId} - Initial Position]`);
      const containerRect = container.getBoundingClientRect();
      updateSliderPosition(containerRect.width / 2); // Inicia no centro
    }

    // Chama a função de posição inicial
    setInitialPosition();

    // Reajusta a posição quando a janela é redimensionada
    window.addEventListener('resize', setInitialPosition);
  }

  // --- Inicializa cada seção de comparação de imagens na página ---
  // Shopify injeta o ID da seção aqui
  const currentSectionId = {{ section.id | json }};
  if (currentSectionId) {
    initImageComparison(currentSectionId);
  }

  // Se você tiver um carregamento de seções dinâmico (por exemplo, no editor de temas),
  // pode precisar de um ouvinte para quando uma nova seção é adicionada.
  // Isso é mais complexo e pode variar por tema. Para a maioria dos casos,
  // o código acima deve ser suficiente.
  // document.addEventListener('shopify:section:load', function(event) {
  //   if (event.detail.sectionId.startsWith('image-comparison-')) { // Ajuste o prefixo se necessário
  //     initImageComparison(event.detail.sectionId);
  //   }
  // });
</script>


{% schema %}
{
  "name": "Comparação",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título da Seção",
      "default": "Compare a Evolução"
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "Imagem 'Antes'",
      "info": "A imagem original ou 'antes'."
    },
    {
      "type": "text",
      "id": "label_before",
      "label": "Texto 'Antes'",
      "default": "Série Anterior"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "Imagem 'Depois'",
      "info": "A imagem nova ou 'depois'."
    },
    {
      "type": "text",
      "id": "label_after",
      "label": "Texto 'Depois'",
      "default": "Série Nova"
    },
    {
      "type": "range",
      "id": "initial_slider_position",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Posição Inicial do Slider",
      "default": 50,
      "info": "Define a posição inicial do slider em porcentagem (0% = todo 'depois', 100% = todo 'antes')."
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 300,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "label": "Largura Máxima do Slider",
      "default": 1000,
      "info": "Largura máxima do container de comparação de imagens."
    },
    {
      "type": "range",
      "id": "aspect_ratio",
      "min": 0.5,
      "max": 2.0,
      "step": 0.1,
      "label": "Proporção da Imagem (Largura/Altura)",
      "default": 1.3,
      "info": "Define a proporção da imagem (ex: 1.3 para 4:3, 1.7 para 16:9). Ajuste para a proporção das suas imagens."
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Cor de Fundo da Seção",
      "default": "#f5f5f7"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Cor do Texto",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "slider_line_color",
      "label": "Cor da Linha do Slider",
      "default": "#007aff"
    },
    {
      "type": "color",
      "id": "slider_handle_color",
      "label": "Cor do Handle do Slider",
      "default": "#007aff"
    }
  ],
  "presets": [
    {
      "name": "Comparação de Imagens (Apple)",
      "category": "Imagens e Vídeos"
    }
  ]
}
{% endschema %}